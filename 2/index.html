<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Prokudin-Gorskii Project - Colorizing the Russian Empire</title>

  <!-- MathJax for LaTeX rendering -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #f9f9f9;
      color: #333;
    }
    h1, h2 {
      text-align: center;
    }
    .desc {
      max-width: 900px;
      margin: auto;
      line-height: 1.6;
    }
    /* Make LaTeX a bit larger + match text */
    .MathJax {
      font-size: 1.1em;
    }

    /* Gallery */
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin: 30px auto;
      max-width: 1200px;
    }
    .gallery img {
      width: 100%;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }
    .gallery figure {
      margin: 0;
      text-align: center;
      font-size: 0.9em;
      color: #555;
    }

    /* Shifts table */
    table {
      border-collapse: collapse;
      margin: 40px auto;
      width: 90%;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }

    /* Favorites section */
    .favorites {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin: 40px auto;
      flex-wrap: wrap;
      max-width: 1800px;
    }
    .favorites img {
      width: 100%;
      max-width: 500px; /* Larger than regular gallery images */
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.25);
    }
    .favorites figure {
      margin: 0;
      text-align: center;
      font-size: 1em;
      color: #444;
    }
  </style>
</head>
<body>
  <h2>Colorizing the Prokudin-Gorskii Photo Collection</h2>

  <div class="desc">
    <p>
      This project reconstructs color images by aligning the three R, G, B images together, using some similarity metric. 
    </p>
    <p>
      This was initially done using Normalized Cross Correllation, but switched to Sklearn's Mutual Information Score in the Bells and Whistles for better alignment
    </p>
    <p>
      My alignment takes a ~150px window in the center of the image, and shifts it around ~15 pixels, and chooses the transformation with the highest score.
    </p>
    <p>
      The alignment also leverages image pyramids, and starts off on a 3x downsampled image, and aligns subsequent images afterwards, starting on the previous alignment.
    </p>
  </div>

<h2>Normalized Cross Covariance Results</h2>
<div class="gallery">
  <figure><img src="good_images_ncc/aligned_italil.jpg" alt="italil"><figcaption>Italil</figcaption></figure>
  <figure><img src="good_images_ncc/aligned_tobolsk.jpg" alt="tobolsk"><figcaption>Tobolsk</figcaption></figure>
  <figure><img src="good_images_ncc/aligned_harvesters.jpg" alt="harvesters"><figcaption>Harvesters</figcaption></figure>
  <figure><img src="good_images_ncc/aligned_icon.jpg" alt="icon"><figcaption>Icon</figcaption></figure>
  <figure><img src="good_images_ncc/aligned_church.jpg" alt="church"><figcaption>Church</figcaption></figure>
  <figure><img src="good_images_ncc/aligned_siren.jpg" alt="siren"><figcaption>Siren</figcaption></figure>
  <figure><img src="good_images_ncc/aligned_three_generations.jpg" alt="three generations"><figcaption>Three Generations</figcaption></figure>
  <figure><img src="good_images_ncc/aligned_emir.jpg" alt="emir"><figcaption>Emir</figcaption></figure>
  <figure><img src="good_images_ncc/aligned_melons.jpg" alt="melons"><figcaption>Melons</figcaption></figure>
  <figure><img src="good_images_ncc/aligned_monastery.jpg" alt="monastery"><figcaption>Monastery</figcaption></figure>
  <figure><img src="good_images_ncc/aligned_lastochikino.jpg" alt="lastochikino"><figcaption>Lastochikino</figcaption></figure>
  <figure><img src="good_images_ncc/aligned_cathedral.jpg" alt="cathedral"><figcaption>Cathedral</figcaption></figure>
  <figure><img src="good_images_ncc/aligned_lugano.jpg" alt="lugano"><figcaption>Lugano</figcaption></figure>
  <figure><img src="good_images_ncc/aligned_self_portrait.jpg" alt="self portrait"><figcaption>Self Portrait</figcaption></figure>
  <figure><img src="good_images_ncc/aligned_little_boy.jpg" alt="little boy"><figcaption>Little Boy</figcaption></figure>
  <figure><img src="good_images_ncc/aligned_waterfall.jpg" alt="waterfall"><figcaption>Waterfall</figcaption></figure>
  <figure><img src="good_images_ncc/aligned_lake.jpg" alt="lake"><figcaption>Lake</figcaption></figure>
</div>

<h2>Mutual Information Results</h2>
<div class="gallery">
  <figure><img src="good_images_mutual_info/aligned_italil.jpg" alt="italil"><figcaption>Italil</figcaption></figure>
  <figure><img src="good_images_mutual_info/aligned_tobolsk.jpg" alt="tobolsk"><figcaption>Tobolsk</figcaption></figure>
  <figure><img src="good_images_mutual_info/aligned_harvesters.jpg" alt="harvesters"><figcaption>Harvesters</figcaption></figure>
  <figure><img src="good_images_mutual_info/aligned_icon.jpg" alt="icon"><figcaption>Icon</figcaption></figure>
  <figure><img src="good_images_mutual_info/aligned_church.jpg" alt="church"><figcaption>Church</figcaption></figure>
  <figure><img src="good_images_mutual_info/aligned_siren.jpg" alt="siren"><figcaption>Siren</figcaption></figure>
  <figure><img src="good_images_mutual_info/aligned_three_generations.jpg" alt="three generations"><figcaption>Three Generations</figcaption></figure>
  <figure><img src="good_images_mutual_info/aligned_emir.jpg" alt="emir"><figcaption>Emir</figcaption></figure>
  <figure><img src="good_images_mutual_info/aligned_melons.jpg" alt="melons"><figcaption>Melons</figcaption></figure>
  <figure><img src="good_images_mutual_info/aligned_monastery.jpg" alt="monastery"><figcaption>Monastery</figcaption></figure>
  <figure><img src="good_images_mutual_info/aligned_lastochikino.jpg" alt="lastochikino"><figcaption>Lastochikino</figcaption></figure>
  <figure><img src="good_images_mutual_info/aligned_cathedral.jpg" alt="cathedral"><figcaption>Cathedral</figcaption></figure>
  <figure><img src="good_images_mutual_info/aligned_lugano.jpg" alt="lugano"><figcaption>Lugano</figcaption></figure>
  <figure><img src="good_images_mutual_info/aligned_self_portrait.jpg" alt="self portrait"><figcaption>Self Portrait</figcaption></figure>
  <figure><img src="good_images_mutual_info/aligned_little_boy.jpg" alt="little boy"><figcaption>Little Boy</figcaption></figure>
  <figure><img src="good_images_mutual_info/aligned_waterfall.jpg" alt="waterfall"><figcaption>Waterfall</figcaption></figure>
  <figure><img src="good_images_mutual_info/aligned_lake.jpg" alt="lake"><figcaption>Lake</figcaption></figure>
</div>

<h2>My Personal Favorites</h2>
<div class="favorites">
  <figure>
    <img src="good_images_mutual_info/aligned_waterfall.jpg" alt="waterfall">
    <figcaption>Waterfall</figcaption>
  </figure>
  <figure>
    <img src="good_images_mutual_info/aligned_church.jpg" alt="church">
    <figcaption>Church</figcaption>
  </figure>
  <figure>
    <img src="good_images_mutual_info/aligned_self_portrait.jpg" alt="self portrait">
    <figcaption>Self Portrait</figcaption>
  </figure>
</div>

  <h2>Alignment Shifts</h2>
  <table>
    <tr>
      <th>Image</th>
      <th>Red Shift (x, y)</th>
      <th>Green Shift (x, y)</th>
    </tr>
    <tr><td>Italil</td><td>(79, 30)</td><td>(37, 20)</td></tr>
    <tr><td>Tobolsk</td><td>(7, 3)</td><td>(3, 3)</td></tr>
    <tr><td>Harvesters</td><td>(123, 14)</td><td>(58, 16)</td></tr>
    <tr><td>Icon</td><td>(90, 22)</td><td>(41, 17)</td></tr>
    <tr><td>Church</td><td>(?, ?)</td><td>(?, ?)</td></tr>
    <tr><td>Siren</td><td>(98, 25)</td><td>(50, -5)</td></tr>
    <tr><td>Three Generations</td><td>(108, 13)</td><td>(51, 14)</td></tr>
    <tr><td>Emir</td><td>(107, 41)</td><td>(49, 22)</td></tr>
    <tr><td>Melons</td><td>(180, 13)</td><td>(84, 8)</td></tr>
    <tr><td>Monastery</td><td>(3, 2)</td><td>(-3, 2)</td></tr>
    <tr><td>Lastochikino</td><td>(73, -8)</td><td>(-10, 1)</td></tr>
    <tr><td>Cathedral</td><td>(12, 3)</td><td>(5, 2)</td></tr>
    <tr><td>Lugano</td><td>(92, -28)</td><td>(40, -15)</td></tr>
    <tr><td>Self Portrait</td><td>(175, 35)</td><td>(77, 27)</td></tr>
    <tr><td>Little Boy</td><td>(102, -10)</td><td>(45, -13)</td></tr>
    <tr><td>Waterfall</td><td>(111, -1)</td><td>(31, 0)</td></tr>
    <tr><td>Lake</td><td>(113, -14)</td><td>(51, -1)</td></tr>
  </table>

<div class="desc">
  <h2>Implementation:</h2>

  <h3>Normalized Cross Correllation (NCC)</h3>
  <p>
    To align two images, I used <b>Normalized Cross Correllation</b> as the
    similarity metric. It's just like the Cross Correllation metric discussed in the project spec, but also normalizes
    the pixel values by subtracting the mean, to make it less prone to errors from brightness and contrast scaling.
  </p>
  <p>
    The formula for NCC between two image patches \(A\) and \(B\) is:
  </p>
  <p>
    \[
      \text{NCC}(A, B) =
      \frac{\sum_{i}(A_i - \bar{A})(B_i - \bar{B})}
      {\sqrt{\sum_i (A_i - \bar{A})^2} \; \sqrt{\sum_i (B_i - \bar{B})^2}}
    \]
  </p>
  <p>
    where \( \bar{A} \) and \( \bar{B} \) are the mean intensities of
    the patches. The score ranges from -1 to 1, with 1 meaning perfect
    alignment.
  </p>

  <h3>Image Pyramids</h3>
  <p>
    Searching for the best alignment directly at full resolution is
    computationally expensive (although my computer is stupid fast so not really for me). So I use an <b>image pyramid</b>.
    which repeatedly downsamples the image (keeping every other
    pixel) to make smaller versions
  </p>
  <p>
    Alignment starts from the <i>coarsest level</i> (smallest image) and
    then shifts the image every way across the search grid, and chooses the most optimal shift via the NCC score.
    Even though the box size and search radius stay constant at each level,
    the total number of pixels is smaller, which makes the search faster.
  </p>

  <h2>Bells and Whistles</h2>

  <h3>Color Grading</h3>
  <p>
    A simple method is to normalize pixel intensities so that the minimum
    becomes 0 and the maximum becomes 1, and linearly map everything in
    between:
  </p>
  <p>
    \[
      I_{\text{norm}} = \frac{I - \min(I)}{\max(I) - \min(I)}
    \]
  </p>
  <p>
    I also tried histogram matching for each color channel, which forces
    the cumulative distribution of pixel values to match a target. However,
    this often led to unnatural color shifts, so the simpler linear scaling
    looked better.
  </p>

  <h3>Auto-Cropping</h3>
  <p>
    To automatically remove borders from the image, I used scipy's sobel
    edge detector to find strong vertical and horizontal edges. I sum
    over all the rows and columns. After inspecting the data, you can pretty 
    confidently say that if the sum is greater than 0.1 * total_pixels, it's a border
  </p>
  <p>
    I also make sure cropping is only used near the outer 10% of the image dimensions, so 
    there's less chance of accidentally cropping way too much
  </p>
</div>

</body>
</html>


